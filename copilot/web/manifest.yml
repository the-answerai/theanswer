# The manifest for the "web" service.
# Read the full specification for the "Load Balanced Web Service" type at:
#  https://aws.github.io/copilot-cli/docs/manifest/lb-web-service/

# Your service name will be used in naming your resources like log groups, ECS services, etc.
name: web
type: Load Balanced Web Service

# Distribute traffic to your service.
http:
    # Requests to this path will be forwarded to your service.
    path: '/'
    # Temporarily disabled for testing
    # healthcheck: '/api/auth/session'
    # Health check - dead simple endpoint that ALWAYS works
    healthcheck: '/healthcheck'
    # Domain aliases configured in environment-specific overrides below
    # Disable stickiness for now
    # stickiness: true

# Configuration for your containers and service.
image:
    # Docker build arguments
    build:
        dockerfile: ./apps/web/Dockerfile
        context: .
        args:
            AUTH0_BASE_URL: ${AUTH0_BASE_URL}
            AUTH0_SECRET: ${AUTH0_SECRET}
            AUTH0_ISSUER_BASE_URL: ${AUTH0_ISSUER_BASE_URL}
            AUTH0_CLIENT_ID: ${AUTH0_CLIENT_ID}
            AUTH0_CLIENT_SECRET: ${AUTH0_CLIENT_SECRET}
            AUTH0_AUDIENCE: ${AUTH0_AUDIENCE}
            AUTH0_ORGANIZATION_ID: ${AUTH0_ORGANIZATION_ID}
            AUTH0_DOMAIN: ${AUTH0_DOMAIN}
            FLAGSMITH_ENVIRONMENT_ID: ${FLAGSMITH_ENVIRONMENT_ID}
            WEB_AUTH0_SECRET: ${WEB_AUTH0_SECRET}
            # DATABASE_URL: ${DATABASE_URL}
            # BWS_ACCESS_TOKEN: ${BWS_ACCESS_TOKEN}
    # Port exposed through your container to route traffic to it.
    port: 3000

# Resource configuration moved to environment-specific overrides below
exec: true # Enable running commands in your container

# Enable Service Connect for intra-environment traffic between services
network:
    connect: true
    vpc:
        security_groups:
            - from_cfn: ${COPILOT_APPLICATION_NAME}-${COPILOT_ENVIRONMENT_NAME}-flowiseclusterSecurityGroup
            - from_cfn: ${COPILOT_APPLICATION_NAME}-${COPILOT_ENVIRONMENT_NAME}-RedisWorkloadSecurityGroup

# Load environment-specific variables from file
env_file: copilot.${COPILOT_ENVIRONMENT_NAME}.web.env

# Database secret from AWS Secrets Manager
secrets:
    DATABASE_SECRET:
        from_cfn: ${COPILOT_APPLICATION_NAME}-${COPILOT_ENVIRONMENT_NAME}-flowiseclusterAuroraSecret

# Optional fields for more advanced use-cases.
variables: # Pass environment variables as key value pairs.
    NUMBER_OF_PROXIES: '1'
    NODE_ENV: production
    PORT: '3000'
    HOSTNAME: '0.0.0.0'
    NEXT_TELEMETRY_DISABLED: '1'
    AUTH0_DEBUG: 'false' # Disable Auth0 debugging in production
    AUTH0_BASE_URL: ${AUTH0_BASE_URL}
    ANSWERAI_DOMAIN: 'http://web:3000'
    FLOWISE_DOMAIN: 'http://flowise:4000'
    DOMAIN: 'http://flowise:4000'
    # External API endpoint for OAuth callbacks, MCP tools, and external integrations
    API_HOST: 'https://api.${CLIENT_DOMAIN}'
    # Database separation: Web service uses different database than Flowise
    WEB_DATABASE_NAME: 'web' # Override flowise database name from shared secret
    REDIS_URL:
        from_cfn: ${COPILOT_APPLICATION_NAME}-${COPILOT_ENVIRONMENT_NAME}-RedisURL

# Environment-specific overrides
environments:
    # Default: Same account deployment (staging and prod share account)
    staging:
        cpu: 1024 # Number of CPU units for the task
        memory: 2048 # Amount of memory in MiB used by the task
        count: 1 # Number of tasks that should be running in your service
        http:
            alias:
                # Service aliases for same account strategy
                - web.staging.${CLIENT_DOMAIN}
                - staging.${CLIENT_DOMAIN}
    prod:
        cpu: 2048 # Number of CPU units for the task
        memory: 4096 # Amount of memory in MiB used by the task
        count: 1 # Number of tasks that should be running in your service
        http:
            alias:
                # Service aliases for same account strategy
                - web.prod.${CLIENT_DOMAIN}
                - prod.${CLIENT_DOMAIN}
                - ${CLIENT_DOMAIN}

    # Standalone: Separate account deployment (independent accounts)
    staging-standalone:
        cpu: 1024 # Number of CPU units for the task
        memory: 2048 # Amount of memory in MiB used by the task
        count: 1 # Number of tasks that should be running in your service
        http:
            alias:
                # Service aliases for standalone account strategy
                - web.${CLIENT_DOMAIN}
                - ${CLIENT_DOMAIN}
    prod-standalone:
        cpu: 2048 # Number of CPU units for the task
        memory: 4096 # Amount of memory in MiB used by the task
        count: 1 # Number of tasks that should be running in your service
        http:
            alias:
                # Service aliases for standalone account strategy
                - web.${CLIENT_DOMAIN}
                - ${CLIENT_DOMAIN}

# Configure deployment strategy
deployment:
    rolling: 'default'
